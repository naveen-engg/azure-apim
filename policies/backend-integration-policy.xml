<policies>
    <!--
    ============================================================================
    BACKEND INTEGRATION POLICY
    ============================================================================
    
    This policy handles routing to your actual backend services.
    
    IMPORTANT CLARIFICATION:
    - MuleSoft is NOT a backend service
    - MuleSoft is an EXTERNAL CLIENT that calls your API Gateway
    - This policy is for routing to your actual backend APIs (microservices, 
      legacy systems, databases, etc.)
    
    If you're using MuleSoft:
    - MuleSoft makes HTTPS requests TO your App Gateway Public IP/FQDN
    - MuleSoft authenticates using JWT tokens from Auth0
    - MuleSoft is treated like any other external client
    - NO special policy needed for MuleSoft
    
    ============================================================================
    -->
    
    <inbound>
        <base />
        
        <!-- Validate JWT token (should be applied at API/Product level) -->
        
        <!-- Set backend service URL from named value -->
        <set-backend-service base-url="{{backend-service-url}}" />
        
        <!-- Add standard headers for backend -->
        <set-header name="X-Source-System" exists-action="override">
            <value>APIM</value>
        </set-header>
        
        <set-header name="X-Transaction-Id" exists-action="skip">
            <value>@(Guid.NewGuid().ToString())</value>
        </set-header>
        
        <set-header name="X-Correlation-Id" exists-action="skip">
            <value>@(context.RequestId)</value>
        </set-header>
        
        <!-- Circuit breaker pattern for backend resilience -->
        <retry 
            condition="@(context.Response.StatusCode >= 500)" 
            count="3" 
            interval="2" 
            delta="1" 
            max-interval="10">
            <forward-request buffer-request-body="true" timeout="60" />
        </retry>
    </inbound>
    
    <backend>
        <base />
        <forward-request timeout="60" buffer-request-body="true" />
    </backend>
    
    <outbound>
        <base />
        
        <!-- Add standard response headers -->
        <set-header name="X-Response-Time" exists-action="override">
            <value>@(context.Elapsed.TotalMilliseconds.ToString())</value>
        </set-header>
        
        <set-header name="X-Correlation-Id" exists-action="override">
            <value>@(context.RequestId)</value>
        </set-header>
    </outbound>
    
    <on-error>
        <base />
        
        <!-- Return standardized error response -->
        <return-response>
            <set-status code="@(context.Response?.StatusCode ?? 502)" reason="@(context.Response?.StatusReason ?? 'Bad Gateway')" />
            <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
            </set-header>
            <set-body>@{
                return new JObject(
                    new JProperty("error", new JObject(
                        new JProperty("code", "BACKEND_ERROR"),
                        new JProperty("message", "Error communicating with backend service"),
                        new JProperty("correlationId", context.RequestId),
                        new JProperty("timestamp", DateTime.UtcNow.ToString("o"))
                    ))
                ).ToString();
            }</set-body>
        </return-response>
    </on-error>
</policies>
