<policies>
    <inbound>
        <base />
        <!-- Validate JWT token (inherited from Auth0 policy if applied at product/API level) -->
        
        <!-- Set MuleSoft backend URL from named value -->
        <set-backend-service base-url="{{mulesoft-backend-url}}" />
        
        <!-- Add MuleSoft-specific headers -->
        <set-header name="X-Source-System" exists-action="override">
            <value>APIM</value>
        </set-header>
        
        <set-header name="X-Transaction-Id" exists-action="skip">
            <value>@(Guid.NewGuid().ToString())</value>
        </set-header>
        
        <!-- Get MuleSoft credentials from Key Vault -->
        <set-variable name="mulesoft-client-id" value="{{mulesoft-client-id}}" />
        <set-variable name="mulesoft-client-secret" value="{{mulesoft-client-secret}}" />
        
        <!-- Add MuleSoft authentication -->
        <authentication-basic username="@(context.Variables.GetValueOrDefault<string>("mulesoft-client-id"))" 
                               password="@(context.Variables.GetValueOrDefault<string>("mulesoft-client-secret"))" />
        
        <!-- Transform request for MuleSoft format if needed -->
        <set-body>@{
            var body = context.Request.Body.As<JObject>(preserveContent: true);
            if (body == null) return context.Request.Body.As<string>(preserveContent: true);
            
            // Add MuleSoft envelope
            var mulesoftRequest = new JObject(
                new JProperty("header", new JObject(
                    new JProperty("transactionId", context.Variables.GetValueOrDefault<string>("X-Transaction-Id")),
                    new JProperty("timestamp", DateTime.UtcNow.ToString("o")),
                    new JProperty("sourceSystem", "APIM"),
                    new JProperty("userId", context.Variables.GetValueOrDefault<string>("user-id", ""))
                )),
                new JProperty("payload", body)
            );
            
            return mulesoftRequest.ToString();
        }</set-body>
        
        <!-- Circuit breaker pattern -->
        <retry 
            condition="@(context.Response.StatusCode >= 500)" 
            count="3" 
            interval="2" 
            delta="1" 
            max-interval="10">
            <choose>
                <when condition="@(context.Variables.GetValueOrDefault<int>("retry-count", 0) >= 2)">
                    <!-- If retries exhausted, return fallback response -->
                    <return-response>
                        <set-status code="503" reason="Service Unavailable" />
                        <set-header name="Content-Type" exists-action="override">
                            <value>application/json</value>
                        </set-header>
                        <set-body>@{
                            return new JObject(
                                new JProperty("error", new JObject(
                                    new JProperty("code", "SERVICE_UNAVAILABLE"),
                                    new JProperty("message", "MuleSoft service is temporarily unavailable. Please try again later."),
                                    new JProperty("correlationId", context.RequestId),
                                    new JProperty("timestamp", DateTime.UtcNow.ToString("o"))
                                ))
                            ).ToString();
                        }</set-body>
                    </return-response>
                </when>
                <otherwise>
                    <set-variable name="retry-count" value="@(context.Variables.GetValueOrDefault<int>("retry-count", 0) + 1)" />
                    <forward-request buffer-request-body="true" timeout="60" />
                </otherwise>
            </choose>
        </retry>
    </inbound>
    
    <backend>
        <base />
        <!-- Forward to MuleSoft with timeout -->
        <forward-request timeout="60" buffer-request-body="true" />
    </backend>
    
    <outbound>
        <base />
        <!-- Transform MuleSoft response to standard format -->
        <choose>
            <when condition="@(context.Response.StatusCode == 200)">
                <set-body>@{
                    var response = context.Response.Body.As<JObject>(preserveContent: true);
                    if (response == null) return context.Response.Body.As<string>(preserveContent: true);
                    
                    // Extract payload from MuleSoft envelope
                    if (response["payload"] != null) {
                        return response["payload"].ToString();
                    }
                    
                    return response.ToString();
                }</set-body>
            </when>
        </choose>
        
        <!-- Add response headers -->
        <set-header name="X-MuleSoft-Integration" exists-action="override">
            <value>true</value>
        </set-header>
        
        <set-header name="X-Response-Time" exists-action="override">
            <value>@(context.Elapsed.TotalMilliseconds.ToString())</value>
        </set-header>
        
        <!-- Log MuleSoft interaction -->
        <trace source="mulesoft-integration" severity="information">
            <message>@{
                return new JObject(
                    new JProperty("transactionId", context.Variables.GetValueOrDefault<string>("X-Transaction-Id")),
                    new JProperty("correlationId", context.RequestId),
                    new JProperty("method", context.Request.Method),
                    new JProperty("url", context.Request.Url.Path),
                    new JProperty("statusCode", context.Response.StatusCode),
                    new JProperty("responseTime", context.Elapsed.TotalMilliseconds),
                    new JProperty("timestamp", DateTime.UtcNow.ToString("o"))
                ).ToString();
            }</message>
        </trace>
    </outbound>
    
    <on-error>
        <base />
        <!-- Log MuleSoft errors with additional context -->
        <trace source="mulesoft-integration-error" severity="error">
            <message>@{
                return new JObject(
                    new JProperty("transactionId", context.Variables.GetValueOrDefault<string>("X-Transaction-Id")),
                    new JProperty("correlationId", context.RequestId),
                    new JProperty("error", context.LastError?.Message ?? "Unknown error"),
                    new JProperty("source", "MuleSoft Integration"),
                    new JProperty("path", context.Request.Url.Path),
                    new JProperty("method", context.Request.Method),
                    new JProperty("timestamp", DateTime.UtcNow.ToString("o"))
                ).ToString();
            }</message>
        </trace>
        
        <!-- Return standardized error response -->
        <return-response>
            <set-status code="@(context.Response?.StatusCode ?? 502)" reason="@(context.Response?.StatusReason ?? "Bad Gateway")" />
            <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
            </set-header>
            <set-body>@{
                return new JObject(
                    new JProperty("error", new JObject(
                        new JProperty("code", "MULESOFT_ERROR"),
                        new JProperty("message", "Error communicating with backend integration service"),
                        new JProperty("details", context.LastError?.Message ?? ""),
                        new JProperty("transactionId", context.Variables.GetValueOrDefault<string>("X-Transaction-Id")),
                        new JProperty("correlationId", context.RequestId),
                        new JProperty("timestamp", DateTime.UtcNow.ToString("o"))
                    ))
                ).ToString();
            }</set-body>
        </return-response>
    </on-error>
</policies>
