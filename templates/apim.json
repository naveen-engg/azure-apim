{
  /*
   * ============================================================================
   * API MANAGEMENT TEMPLATE - Internal VNet Mode
   * ============================================================================
   * Purpose: Creates APIM service with Auth0 integration
   * 
   * Dependencies:
   *   - network.json (needs APIM subnet ID)
   *   - monitoring.json (needs workspace ID and instrumentation key)
   *   - keyvault.json (for later secret access)
   * 
   * Resources Created:
   *   1. API Management Service - Internal VNet mode
   *   2. Managed Identity - For Key Vault access
   *   3. Named Values - Auth0 domain, audience, backend URL
   *   4. App Insights Logger - For telemetry
   *   5. Diagnostic Settings - Send logs to Log Analytics
   * 
   * Returns:
   *   - apimPrivateIp → Used by App Gateway backend pool
   *   - apimPrincipalId → Use to grant Key Vault access
   * 
   * IMPORTANT: Deployment takes 40-50 minutes!
   * ============================================================================
   */

  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  
  "parameters": {
    "location": {
      "type": "string"
    },
    
    "apimName": {
      // Generated as: {projectName}-{environment}-apim
      "type": "string"
    },
    
    "apimSku": {
      // Developer = Dev/Staging (~$50/month, no SLA)
      // Premium = Production (~$2,975/month per unit, 99.95% SLA)
      "type": "string",
      "allowedValues": ["Developer", "Premium"]
    },
    
    "apimCapacity": {
      // Number of units: 1 for dev/staging, 2+ for prod
      "type": "int"
    },
    
    "vnetName": {
      "type": "string"
    },
    
    "apimSubnetName": {
      // Fixed name from network.json: "apim-subnet"
      "type": "string"
    },
    
    "keyVaultName": {
      "type": "string"
    },
    
    "auth0Domain": {
      // Example: "contoso.auth0.com"
      // Used in policies for JWT validation
      "type": "string"
    },
    
    "auth0Audience": {
      // Example: "https://api.contoso.com"
      // Used in policies for JWT validation
      "type": "string"
    },
    
    "backendServiceUrl": {
      // YOUR backend API URL (NOT MuleSoft - that's an external client)
      // Example: "https://backend.contoso.com"
      "type": "string",
      "defaultValue": ""
    },
    
    "logAnalyticsWorkspaceId": {
      // Passed from monitoring.json output
      "type": "string"
    },
    
    "appInsightsInstrumentationKey": {
      // Passed from monitoring.json output
      // Used to create APIM logger
      "type": "string"
    }
  },
  
  "variables": {
    "apimSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('apimSubnetName'))]"
  },
  
  "resources": [
    /*
     * API MANAGEMENT SERVICE
     * Internal VNet mode - not directly accessible from internet
     * Access via App Gateway only
     */
    {
      "type": "Microsoft.ApiManagement/service",
      "apiVersion": "2023-03-01-preview",
      "name": "[parameters('apimName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('apimSku')]",
        "capacity": "[parameters('apimCapacity')]"
      },
      "identity": {
        // System-assigned Managed Identity for Key Vault access
        "type": "SystemAssigned"
      },
      "properties": {
        "publisherEmail": "admin@contoso.com",  // UPDATE if needed
        "publisherName": "Contoso",              // UPDATE if needed
        
        /*
         * VIRTUAL NETWORK CONFIGURATION
         * Internal mode = APIM is only accessible from within VNet
         * External clients access via App Gateway
         */
        "virtualNetworkType": "Internal",
        "virtualNetworkConfiguration": {
          "subnetResourceId": "[variables('apimSubnetId')]"
        },
        
        /*
         * CUSTOM PROPERTIES (Named Values)
         * Referenced in policies using {{name}} syntax
         */
        "customProperties": {
          // Enforce TLS 1.2+ only (disable older protocols)
          "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Protocols.Tls10": "false",
          "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Protocols.Tls11": "false",
          "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Protocols.Ssl30": "false",
          
          // Require TLS 1.2 for backend connections
          "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Backend.Protocols.Tls10": "false",
          "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Backend.Protocols.Tls11": "false",
          "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Backend.Protocols.Ssl30": "false",
          
          // Disable weak ciphers
          "Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Ciphers.TripleDes168": "false"
        }
      }
    },
    
    /*
     * NAMED VALUE: Auth0 Domain
     * Used in policies: {{auth0-domain}}
     */
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-03-01-preview",
      "name": "[concat(parameters('apimName'), '/auth0-domain')]",
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]"
      ],
      "properties": {
        "displayName": "auth0-domain",
        "value": "[parameters('auth0Domain')]",
        "secret": false
      }
    },
    
    /*
     * NAMED VALUE: Auth0 Audience
     * Used in policies: {{auth0-audience}}
     */
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-03-01-preview",
      "name": "[concat(parameters('apimName'), '/auth0-audience')]",
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]"
      ],
      "properties": {
        "displayName": "auth0-audience",
        "value": "[parameters('auth0Audience')]",
        "secret": false
      }
    },
    
    /*
     * NAMED VALUE: Backend Service URL
     * Used in policies: {{backend-service-url}}
     * This is YOUR backend API, NOT MuleSoft (MuleSoft is a client)
     */
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-03-01-preview",
      "name": "[concat(parameters('apimName'), '/backend-service-url')]",
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]"
      ],
      "properties": {
        "displayName": "backend-service-url",
        "value": "[if(empty(parameters('backendServiceUrl')), 'https://backend.example.com', parameters('backendServiceUrl'))]",
        "secret": false
      }
    },
    
    /*
     * APPLICATION INSIGHTS LOGGER
     * Sends telemetry to Application Insights
     */
    {
      "type": "Microsoft.ApiManagement/service/loggers",
      "apiVersion": "2023-03-01-preview",
      "name": "[concat(parameters('apimName'), '/apim-logger')]",
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]"
      ],
      "properties": {
        "loggerType": "applicationInsights",
        "credentials": {
          "instrumentationKey": "[parameters('appInsightsInstrumentationKey')]"
        },
        "isBuffered": true,
        "resourceId": "[parameters('logAnalyticsWorkspaceId')]"
      }
    },
    
    /*
     * DIAGNOSTIC SETTINGS
     * Send APIM logs to Log Analytics
     */
    {
      "type": "Microsoft.ApiManagement/service/diagnostics",
      "apiVersion": "2023-03-01-preview",
      "name": "[concat(parameters('apimName'), '/applicationinsights')]",
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]",
        "[resourceId('Microsoft.ApiManagement/service/loggers', parameters('apimName'), 'apim-logger')]"
      ],
      "properties": {
        "loggerId": "[resourceId('Microsoft.ApiManagement/service/loggers', parameters('apimName'), 'apim-logger')]",
        "alwaysLog": "allErrors",
        "sampling": {
          "samplingType": "fixed",
          "percentage": 100
        },
        "frontend": {
          "request": {
            "headers": ["Content-Type", "Authorization"],
            "body": {
              "bytes": 512
            }
          },
          "response": {
            "headers": ["Content-Type"],
            "body": {
              "bytes": 512
            }
          }
        },
        "backend": {
          "request": {
            "headers": ["Content-Type"],
            "body": {
              "bytes": 512
            }
          },
          "response": {
            "headers": ["Content-Type"],
            "body": {
              "bytes": 512
            }
          }
        }
      }
    },
    
    /*
     * DIAGNOSTIC SETTINGS - Send to Log Analytics
     * Captures gateway logs, metrics
     */
    {
      "type": "Microsoft.ApiManagement/service/providers/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "name": "[concat(parameters('apimName'), '/Microsoft.Insights/apim-diagnostics')]",
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]"
      ],
      "properties": {
        "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
        "logs": [
          {
            "category": "GatewayLogs",
            "enabled": true
          }
        ],
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true
          }
        ]
      }
    }
  ],
  
  "outputs": {
    // APIM service name
    "apimName": {
      "type": "string",
      "value": "[parameters('apimName')]"
    },
    
    // APIM gateway URL (internal only - access via App Gateway)
    "apimGatewayUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ApiManagement/service', parameters('apimName'))).gatewayUrl]"
    },
    
    // APIM private IP address - CRITICAL for App Gateway backend pool
    // App Gateway uses this to route traffic to APIM
    "apimPrivateIp": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ApiManagement/service', parameters('apimName'))).privateIPAddresses[0]]"
    },
    
    // Managed Identity Principal ID - Use to grant Key Vault access
    // Run post-deployment: az keyvault set-policy --object-id {this-value}
    "apimPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ApiManagement/service', parameters('apimName')), '2023-03-01-preview', 'Full').identity.principalId]"
    }
  }
}
